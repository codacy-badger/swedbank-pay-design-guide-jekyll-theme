{% capture headings_workspace %}
  {% comment %}
    Version 1.0.3
      https://github.com/allejo/jekyll-anchor-headings

    "Be the pull request you wish to see in the world." ~Ben Balter

    Usage:
      {% include anchor_headings.html html=content %}

    Parameters:
      * html          (string) - the HTML of compiled markdown generated by kramdown in Jekyll

    Optional Parameters:
      * before_heading (bool)   : false  - Set to true if the anchor should be placed _before_ the heading's content
      * anchorBody    (string) :  ''    - The content that will be placed inside the anchor; the `%heading%` placeholder is available
      * anchor_class   (string) :  ''    - The class(es) that will be used for each anchor. Separate multiple classes with a space
      * anchor_title   (string) :  ''    - The `title` attribute that will be used for anchors
      * h_min         (int)    :  1     - The minimum header level to build an anchor for; any header lower than this value will be ignored
      * h_max         (int)    :  6     - The maximum header level to build an anchor for; any header greater than this value will be ignored
      * body_prefix    (string) :  ''    - Anything that should be inserted inside of the heading tag _before_ its anchor and content
      * bodySuffix    (string) :  ''    - Anything that should be inserted inside of the heading tag _after_ its anchor and content

    Output:
      The original HTML with the addition of anchors inside of all of the h1-h6 headings.
  {% endcomment %}
  {% assign has_include_min_header = include | has_key: 'h_min' %}
  {% assign has_include_max_header = include | has_key: 'h_max' %}
  {% if has_include_min_header == true and include.h_min != empty %}
    {% assign min_header = include.h_min %}
  {% else %}
      {% assign min_header = 1 %}
  {% endif %}
  {% assign max_header = include.h_max | default: 6 %}
  {% assign before_heading = include.before_heading %}
  {% assign nodes = include.html | split: '<h' %}

  {% capture edited_headings %}{% endcapture %}

  {% for _node in nodes %}
    {% capture node %}{{ _node | strip }}{% endcapture %}

    {% if node == "" %}
      {% continue %}
    {% endif %}

    {% assign next_char = node | replace: '"', '' | strip | slice: 0, 1 %}
    {% assign header_level = next_char | times: 1 %}

    <!-- If the level is cast to 0, it means it's not a h1-h6 tag, so let's try to fix it -->
    {% if header_level == 0 %}
      {% if next_char != '<' and next_char != '' %}
        {% capture node %}<h{{ node }}{% endcapture %}
      {% endif %}

      {% capture edited_headings %}{{ edited_headings }}{{ node }}{% endcapture %}
      {% continue %}
    {% endif %}

    {% assign _workspace = node | split: '</h' %}
    {% assign _idWorkspace = _workspace[0] | split: 'id="' %}
    {% assign _idWorkspace = _idWorkspace[1] | split: '"' %}
    {% assign html_id = _idWorkspace[0] %}

    {% capture _h_attr_to_strip %}{{ _workspace[0] | split: '>' | first }}>{% endcapture %}
    {% assign header = _workspace[0] | replace: _h_attr_to_strip, '' %}

    <!-- Build the anchor to inject for our heading -->
    {% capture anchor %}{% endcapture %}

    {% if html_id and header_level >= min_header and header_level <= max_header %}
      {% capture anchor %}href="#{{ html_id}}"{% endcapture %}

      {% if include.anchor_class %}
        {% capture anchor %}{{ anchor }} class="{{ include.anchor_class }}"{% endcapture %}
      {% endif %}

      {% if include.anchor_title %}
        {% capture anchor %}{{ anchor }} title="{{ include.anchor_title | replace: '%heading%', header }}"{% endcapture %}
      {% endif %}

      {% capture anchor %}<a {{ anchor }}>{{ include.anchorBody | replace: '%heading%', header | default: '' }}</a>{% endcapture %}

      <!-- In order to prevent adding extra space after a heading, we'll let the 'anchor' value contain it -->
      {% if before_heading %}
        {% capture anchor %}{{ anchor }} {% endcapture %}
      {% else %}
        {% capture anchor %} {{ anchor }}{% endcapture %}
      {% endif %}
    {% endif %}

    {% capture new_heading %}
      <h{{ _h_attr_to_strip }}
        {{ include.body_prefix }}
        {% if before_heading %}
          {{ anchor }}{{ header }}
        {% else %}
          {{ header }}{{ anchor }}
        {% endif %}
        {{ include.bodySuffix }}
      </h{{ _workspace | last }}
    {% endcapture %}
    {% capture edited_headings %}{{ edited_headings }}{{ new_heading }}{% endcapture %}
  {% endfor %}
{% endcapture %}{% assign headings_workspace = '' %}{{ edited_headings | strip }}
